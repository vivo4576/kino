    <!-- ... всё, что было до этого, остается без изменений ... -->
    <script src="https://securepay.tinkoff.ru/html/payform/js/tinkoff_v2.js"></script>

    <script>
        // --- Секция отладки ---
        const debugDiv = document.createElement('div');
        debugDiv.style.marginTop = '20px';
        debugDiv.style.padding = '10px';
        debugDiv.style.border = '1px solid #ccc';
        debugDiv.style.textAlign = 'left';
        debugDiv.style.fontFamily = 'monospace';
        debugDiv.style.fontSize = '12px';
        debugDiv.style.wordBreak = 'break-all';
        document.querySelector('.container').appendChild(debugDiv);

        function log(message) {
            console.log(message);
            debugDiv.innerHTML += message + '<br>';
        }
        // -----------------------

        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const amount = urlParams.get('amount');
        const orderId = urlParams.get('order_id');
        const description = urlParams.get('description');

        document.getElementById('amount').innerText = amount || '???';
        document.getElementById('description').innerText = description || 'Нет описания';
        
        log('WebApp загружен.');
        log(`Параметры: amount=${amount}, orderId=${orderId}`);

        // --- ВАЖНО: УБЕДИТЕСЬ, ЧТО ЗДЕСЬ ВАШИ ТЕСТОВЫЕ КЛЮЧИ ---
        const terminalKey = "1748600682178DEMO";
        const password = "^wp&BNO0EXwwrs^S";
        // ----------------------------------------------------

        log(`Терминал: ${terminalKey.substring(0, 5)}...`);

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function initPayment() {
            if (!amount || !orderId) {
                log('Ошибка: Недостаточно параметров для начала оплаты.');
                document.getElementById('description').innerText = "Ошибка: не найдены параметры заказа.";
                document.getElementById('loader').style.display = 'none';
                return;
            }

            const payload = {
                TerminalKey: terminalKey,
                Amount: parseInt(amount) * 100,
                OrderId: orderId,
                Description: description,
                Password: password
            };

            const sortedKeys = Object.keys(payload).sort();
            const concatValues = sortedKeys.map(key => payload[key]).join('');
            log('Строка для токена (без пароля): ' + concatValues.replace(password, '***'));
            
            const token = await sha256(concatValues);
            log(`Сгенерирован токен: ${token.substring(0, 10)}...`);

            const tinkoff = new TinkoffPay({
                terminalKey: terminalKey,
                amount: parseInt(amount) * 100,
                orderId: orderId,
                description: description,
                token: token,
                frame: true,
                language: 'ru',
                onSuccess: (res) => {
                    log('SUCCESS!');
                    const dataToSend = JSON.stringify({ status: 'success', order_id: res.OrderId, payment_id: res.PaymentId });
                    tg.sendData(dataToSend);
                },
                onFail: (res) => {
                    log(`FAIL: ${JSON.stringify(res)}`);
                    document.getElementById('description').innerText = `Ошибка оплаты: ${res.Details}`;
                    document.getElementById('loader').style.display = 'none';
                }
            });

            log('Объект TinkoffPay создан. Вызываю embedPayForm...');
            document.getElementById('loader').style.display = 'none';
            tinkoff.embedPayForm('payment-form');
            log('embedPayForm вызван.');
        }

        initPayment();
    </script>
