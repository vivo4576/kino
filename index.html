<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–ª—É—á—à–∏—Ç—å */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 15px; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .list-item { 
            border: 1px solid var(--tg-theme-button-color, #2481cc); 
            background-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 8px; 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item:active {
             background-color: var(--tg-theme-button-color, #2481cc);
             color: var(--tg-theme-button-text-color, #ffffff);
        }
        h2 { 
            color: var(--tg-theme-text-color, #000000); 
            border-bottom: 1px solid var(--tg-theme-hint-color, #a8a8a8);
            padding-bottom: 10px;
        }
        p { margin-top: 5px; color: var(--tg-theme-hint-color, #a8a8a8); }
        button { 
            width: 100%; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold;
            border: none; 
            border-radius: 8px; 
            background-color: var(--tg-theme-button-color, #2481cc); 
            color: var(--tg-theme-button-text-color, #ffffff); 
            cursor: pointer; 
        }
        input { 
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border: 1px solid #ccc;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        #payment-container { 
            position: fixed; 
            z-index: 1000;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            justify-content: center; 
            align-items: center; 
        }
        #payment-form-wrapper { 
            width: 90%; 
            max-width: 400px;
            height: 90%;
            max-height: 600px;
            background: var(--tg-theme-bg-color, #fff); 
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        #close-payment-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            border: none;
            background: #aaa;
            color: white;
            border-radius: 50%;
            font-size: 20px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
    <div id="date-screen" class="screen active">
        <h2>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h2>
        <div id="dates-container"><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç...</p></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 2: –í—ã–±–æ—Ä —Ñ–∏–ª—å–º–∞ -->
    <div id="film-screen" class="screen">
        <h2 id="film-screen-title">üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º</h2>
        <div id="films-container"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 3: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ—Å—Ç -->
    <div id="seat-screen" class="screen">
        <h2 id="seat-screen-title"></h2>
        <div id="seats-container"></div>
        <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</h3>
        <input type="number" id="quantity-input" min="1" value="1">
    </div>

    <!-- –≠–∫—Ä–∞–Ω 4: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
    <div id="user-data-screen" class="screen">
        <h2>üë§ –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
        <input type="text" id="name-input" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="tel" id="phone-input" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã –¢-–ë–∞–Ω–∫–∞ -->
    <div id="payment-container">
        <div id="payment-form-wrapper">
            <button id="close-payment-btn">√ó</button>
            <div id="payment-form" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
    
    <script src="https://securepay.tinkoff.ru/html/payform/js/tinkoff_v2.js"></script>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const SUPABASE_URL = 'https://prvyadrhyvwkxyogtiha.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydnlhZHJoeXZ3a3h5b2d0aWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjA4NjQsImV4cCI6MjA2NTkzNjg2NH0.MDqe2lJOBDfZrisqvTxa7p9MAjOcVSDJaJlk_8l8TUA';
        const TINKOFF_TERMINAL_KEY = '1748600682178DEMO';
        // -----------------

        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const booking = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–æ–Ω–∏

        // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            tg.MainButton.hide();
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
        async function loadDates() {
            const { data, error } = await supabaseClient
                .from('schedule')
                .select('date')
                .gte('date', new Date().toISOString().split('T')[0])
                .order('date', { ascending: true });

            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç:', error);
                document.getElementById('dates-container').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç.';
                return;
            }

            const uniqueDates = [...new Set(data.map(item => item.date))];
            const container = document.getElementById('dates-container');
            container.innerHTML = '';
            if (uniqueDates.length === 0) {
                 container.innerText = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤.';
                 return;
            }
            uniqueDates.forEach(date => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerText = new Date(date + 'T00:00:00').toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric'});
                el.onclick = () => {
                    booking.date = date;
                    loadFilms(date);
                };
                container.appendChild(el);
            });
        }
        
        async function loadFilms(date) {
            const { data, error } = await supabaseClient.from('schedule').select('*').eq('date', date);
            if (error) { console.error(error); return; }

            const container = document.getElementById('films-container');
            container.innerHTML = '';
            data.forEach(film => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerHTML = `<h3>${film.film_name}</h3><p>–ù–∞—á–∞–ª–æ –≤ ${film.film_time}</p>`;
                el.onclick = () => {
                    booking.film_name = film.film_name;
                    booking.film_time = film.film_time;
                    booking.film_data = film;
                    loadSeats(film);
                };
                container.appendChild(el);
            });
            document.getElementById('film-screen-title').innerText = `üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –Ω–∞ ${new Date(date + 'T00:00:00').toLocaleDateString('ru-RU')}`;
            showScreen('film-screen');
        }

        async function loadSeats(film) {
            document.getElementById('seat-screen-title').innerText = film.film_name;
            const container = document.getElementById('seats-container');
            container.innerHTML = '';
            
            const stdSeatsEl = document.createElement('div');
            stdSeatsEl.className = 'list-item';
            stdSeatsEl.innerHTML = `<h3>–û–±—ã—á–Ω—ã–π –ø—É—Ñ</h3><p>–î–æ—Å—Ç—É–ø–Ω–æ: ${film.std_total}</p>`; // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞—Ç–∫–∞
            stdSeatsEl.onclick = () => {
                booking.seat_type = '–æ–±—ã—á–Ω—ã–π';
                showUserDataScreen();
            };

            const bigSeatsEl = document.createElement('div');
            bigSeatsEl.className = 'list-item';
            bigSeatsEl.innerHTML = `<h3>–ë–æ–ª—å—à–æ–π –ø—É—Ñ</h3><p>–î–æ—Å—Ç—É–ø–Ω–æ: ${film.big_total}</p>`;
            bigSeatsEl.onclick = () => {
                booking.seat_type = '–±–æ–ª—å—à–æ–π';
                showUserDataScreen();
            };
            
            if (film.std_total > 0) container.appendChild(stdSeatsEl);
            if (film.big_total > 0) container.appendChild(bigSeatsEl);
            showScreen('seat-screen');
        }

        function showUserDataScreen() {
            showScreen('user-data-screen');
            tg.MainButton.setText('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å');
            tg.MainButton.show();
        }
        
        tg.onEvent('mainButtonClicked', async () => {
            booking.quantity = document.getElementById('quantity-input').value;
            booking.name = document.getElementById('name-input').value;
            booking.phone = document.getElementById('phone-input').value;
            booking.booking_code = String(Math.floor(10000 + Math.random() * 90000));
            booking.status = 'pending';

            if (!booking.name) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.');
                return;
            }
            if (!booking.quantity || booking.quantity < 1) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç.');
                return;
            }
            tg.MainButton.showProgress();

            const { error } = await supabaseClient.from('bookings').insert([
                { name: booking.name, phone: booking.phone, date: booking.date, film_name: booking.film_name, quantity: booking.quantity, seat_type: booking.seat_type, booking_code: booking.booking_code, status: 'pending' }
            ]);
            if (error) {
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å. –û—à–∏–±–∫–∞: ' + error.message);
                tg.MainButton.hideProgress();
                return;
            }
            initTinkoffPayment();
        });

        function initTinkoffPayment() {
            const price = booking.seat_type === '–æ–±—ã—á–Ω—ã–π' ? 500 : 600;
            const amount = price * booking.quantity;
            
            document.getElementById('payment-container').style.display = 'flex';

            const tinkoff = new TinkoffPay({
                terminalKey: TINKOFF_TERMINAL_KEY,
                amount: amount * 100,
                orderId: booking.booking_code,
                description: `–ë—Ä–æ–Ω—å ‚Ññ${booking.booking_code}: ${booking.film_name}`,
                frame: true,
                language: 'ru',
                onSuccess: async (res) => {
                    await supabaseClient.from('bookings').update({ status: 'active' }).eq('booking_code', res.OrderId);
                    
                    const dataToSend = JSON.stringify({
                        status: 'success',
                        order_id: res.OrderId,
                        amount: amount,
                        description: `–ë—Ä–æ–Ω—å ‚Ññ${res.OrderId}: ${booking.film_name}`
                    });
                    tg.sendData(dataToSend);
                },
                onFail: (res) => {
                    tg.showAlert(`–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${res.Details || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'}`);
                    document.getElementById('payment-container').style.display = 'none';
                }
            });
            tg.MainButton.hideProgress();
            tinkoff.embedPayForm('payment-form');
        }
        
        document.getElementById('close-payment-btn').onclick = () => {
            document.getElementById('payment-container').style.display = 'none';
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
        window.onload = () => {
             showScreen('date-screen');
             loadDates();
        };
    </script>
</body>
</html>
