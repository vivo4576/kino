<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É–ª—É—á—à–∏—Ç—å */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .screen { display: none; }
        .screen.active { display: block; }
        .film-card, .time-slot, .seat-type { border: 1px solid var(--tg-theme-button-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; cursor: pointer; }
        h1, h2, h3 { color: var(--tg-theme-text-color); }
        button { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); cursor: pointer; }
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; }
        #payment-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
        #payment-form { width: 90%; height: 90%; background: white; border-radius: 12px; }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω 1: –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
    <div id="date-screen" class="screen active">
        <h2>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h2>
        <div id="dates-container">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç...</div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 2: –í—ã–±–æ—Ä —Ñ–∏–ª—å–º–∞ -->
    <div id="film-screen" class="screen">
        <h2 id="film-screen-title">üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º</h2>
        <div id="films-container"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω 3: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ—Å—Ç -->
    <div id="seat-screen" class="screen">
        <h2>üõãÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞</h2>
        <div id="seats-container"></div>
        <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</h3>
        <input type="number" id="quantity-input" min="1" value="1">
    </div>

    <!-- –≠–∫—Ä–∞–Ω 4: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
    <div id="user-data-screen" class="screen">
        <h2>üë§ –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
        <input type="text" id="name-input" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="tel" id="phone-input" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã –¢-–ë–∞–Ω–∫–∞ -->
    <div id="payment-container">
        <div id="payment-form"></div>
    </div>
    
    <script src="https://securepay.tinkoff.ru/html/payform/js/tinkoff_v2.js"></script>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const SUPABASE_URL = 'https://prvyadrhyvwkxyogtiha.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydnlhZHJoeXZ3a3h5b2d0aWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjA4NjQsImV4cCI6MjA2NTkzNjg2NH0.MDqe2lJOBDfZrisqvTxa7p9MAjOcVSDJaJlk_8l8TUA';
        const TINKOFF_TERMINAL_KEY = '1748600682178DEMO';
        // -----------------

        const tg = window.Telegram.WebApp;
        tg.expand();
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const booking = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–æ–Ω–∏

        // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            tg.MainButton.hide();
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
        async function loadDates() {
            const { data, error } = await supabase
                .from('schedule')
                .select('date')
                .gte('date', new Date().toISOString().split('T')[0]) // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã
                .order('date', { ascending: true });

            if (error) {
                console.error(error);
                return;
            }

            const uniqueDates = [...new Set(data.map(item => item.date))];
            const container = document.getElementById('dates-container');
            container.innerHTML = '';
            uniqueDates.forEach(date => {
                const el = document.createElement('div');
                el.className = 'time-slot';
                el.innerText = new Date(date).toLocaleDateString('ru-RU');
                el.onclick = () => {
                    booking.date = date;
                    loadFilms(date);
                };
                container.appendChild(el);
            });
        }
        
        async function loadFilms(date) {
            const { data, error } = await supabase.from('schedule').select('*').eq('date', date);
            if (error) { console.error(error); return; }

            const container = document.getElementById('films-container');
            container.innerHTML = '';
            data.forEach(film => {
                const el = document.createElement('div');
                el.className = 'film-card';
                el.innerHTML = `<h3>${film.film_name}</h3><p>${film.film_time}</p>`;
                el.onclick = () => {
                    booking.film_name = film.film_name;
                    booking.film_time = film.film_time;
                    loadSeats(film);
                };
                container.appendChild(el);
            });
            document.getElementById('film-screen-title').innerText = `üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –Ω–∞ ${new Date(date).toLocaleDateString('ru-RU')}`;
            showScreen('film-screen');
        }

        async function loadSeats(film) {
            // –í —ç—Ç–æ–π —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–µ—Å—Ç–∞, –Ω–æ —ç—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
            const container = document.getElementById('seats-container');
            container.innerHTML = '';
            
            const stdSeatsEl = document.createElement('div');
            stdSeatsEl.className = 'seat-type';
            stdSeatsEl.innerText = `–û–±—ã—á–Ω—ã–π –ø—É—Ñ (${film.std_total} –º–µ—Å—Ç)`;
            stdSeatsEl.onclick = () => {
                booking.seat_type = '–æ–±—ã—á–Ω—ã–π';
                showUserDataScreen();
            };

            const bigSeatsEl = document.createElement('div');
            bigSeatsEl.className = 'seat-type';
            bigSeatsEl.innerText = `–ë–æ–ª—å—à–æ–π –ø—É—Ñ (${film.big_total} –º–µ—Å—Ç)`;
            bigSeatsEl.onclick = () => {
                booking.seat_type = '–±–æ–ª—å—à–æ–π';
                showUserDataScreen();
            };
            
            container.appendChild(stdSeatsEl);
            container.appendChild(bigSeatsEl);
            showScreen('seat-screen');
        }

        function showUserDataScreen() {
            showScreen('user-data-screen');
            tg.MainButton.setText('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å');
            tg.MainButton.show();
        }
        
        tg.MainButton.onClick(async () => {
            booking.quantity = document.getElementById('quantity-input').value;
            booking.name = document.getElementById('name-input').value;
            booking.phone = document.getElementById('phone-input').value;
            booking.booking_code = String(Math.floor(10000 + Math.random() * 90000));
            booking.status = 'pending';

            if (!booking.name) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—Ä–æ–Ω—å –≤ Supabase
            const { error } = await supabase.from('bookings').insert([booking]);
            if (error) {
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å. –û—à–∏–±–∫–∞: ' + error.message);
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–ª–∞—Ç—É
            initTinkoffPayment();
        });

        function initTinkoffPayment() {
            const price = booking.seat_type === '–æ–±—ã—á–Ω—ã–π' ? 500 : 600;
            const amount = price * booking.quantity;
            
            document.getElementById('payment-container').style.display = 'flex';

            const tinkoff = new TinkoffPay({
                terminalKey: TINKOFF_TERMINAL_KEY,
                amount: amount * 100, // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
                orderId: booking.booking_code,
                description: `–ë—Ä–æ–Ω—å ‚Ññ${booking.booking_code}: ${booking.film_name}`,
                frame: true,
                language: 'ru',
                onSuccess: async (res) => {
                    await supabase.from('bookings').update({ status: 'active' }).eq('booking_code', res.OrderId);
                    
                    const dataToSend = JSON.stringify({
                        status: 'success',
                        order_id: res.OrderId,
                        amount: amount,
                        description: `–ë—Ä–æ–Ω—å ‚Ññ${res.OrderId}: ${booking.film_name}`
                    });
                    tg.sendData(dataToSend);
                },
                onFail: (res) => {
                    tg.showAlert(`–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${res.Details || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'}`);
                    document.getElementById('payment-container').style.display = 'none';
                }
            });
            
            tinkoff.embedPayForm('payment-form');
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
        showScreen('date-screen');
        loadDates();
    </script>
</body>
</html>
