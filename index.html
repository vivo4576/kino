<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 15px; 
            background-color: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .list-item { 
            border: 1px solid var(--tg-theme-button-color, #2481cc); 
            background-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
            border-radius: 8px; 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item:active {
             background-color: var(--tg-theme-button-color, #2481cc);
             color: var(--tg-theme-button-text-color, #ffffff);
        }
        h2 { 
            color: var(--tg-theme-text-color, #000000); 
            border-bottom: 1px solid var(--tg-theme-hint-color, #a8a8a8);
            padding-bottom: 10px;
        }
        p { margin-top: 5px; color: var(--tg-theme-hint-color, #a8a8a8); }
        button { 
            width: 100%; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold;
            border: none; 
            border-radius: 8px; 
            background-color: var(--tg-theme-button-color, #2481cc); 
            color: var(--tg-theme-button-text-color, #ffffff); 
            cursor: pointer; 
        }
        input { 
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border: 1px solid #ccc;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }
        #payment-container { 
            position: fixed; 
            z-index: 1000;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            justify-content: center; 
            align-items: center; 
        }
        #payment-form-wrapper { 
            width: 90%; 
            max-width: 400px;
            height: 90%;
            max-height: 600px;
            background: var(--tg-theme-bg-color, #fff); 
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        #close-payment-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            border: none;
            background: #aaa;
            color: white;
            border-radius: 50%;
            font-size: 20px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω—ã –¥–ª—è Telegram -->
    <div id="telegram-ui">
        <div id="date-screen" class="screen active">
            <h2>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h2>
            <div id="dates-container"><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç...</p></div>
        </div>
        <div id="film-screen" class="screen">
            <h2 id="film-screen-title">üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º</h2>
            <div id="films-container"></div>
        </div>
        <div id="seat-screen" class="screen">
            <h2 id="seat-screen-title"></h2>
            <div id="seats-container"></div>
            <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</h3>
            <input type="number" id="quantity-input" min="1" value="1">
        </div>
        <div id="user-data-screen" class="screen">
            <h2>üë§ –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
            <input type="text" id="name-input" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="tel" id="phone-input" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="debug-controls" style="border-top: 2px dashed #ccc; padding-top: 20px;">
        <h3>–ü–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</h3>
        <button id="debug-select-film-btn" style="margin-top: 10px;">1. –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ñ–∏–ª—å–º</button>
        <button id="debug-select-seat-btn" style="margin-top: 10px;">2. –í—ã–±—Ä–∞—Ç—å –æ–±—ã—á–Ω—ã–π –ø—É—Ñ (2 —à—Ç)</button>
        <button id="debug-confirm-btn" style="margin-top: 10px;">3. –ò–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∂–∞—Ç–∏–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å"</button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–ø–ª–∞—Ç—ã -->
    <div id="payment-container">
        <div id="payment-form-wrapper">
            <button id="close-payment-btn">√ó</button>
            <div id="payment-form" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
    
    <script src="https://securepay.tinkoff.ru/html/payform/js/payform-widget.js"></script>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const SUPABASE_URL = 'https://prvyadrhyvwkxyogtiha.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydnlhZHJoeXZ3a3h5b2d0aWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNjA4NjQsImV4cCI6MjA2NTkzNjg2NH0.MDqe2lJOBDfZrisqvTxa7p9MAjOcVSDJaJlk_8l8TUA';
        const TINKOFF_TERMINAL_KEY = '1748600682178DEMO';
        // -----------------

        const isTelegram = !!(window.Telegram && window.Telegram.WebApp.initData);
        let tg;

        if (isTelegram) {
            tg = window.Telegram.WebApp;
            tg.expand();
            document.getElementById('debug-controls').style.display = 'none';
        } else {
            console.warn("–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ö–Ω–æ–ø–∫–∏ Telegram –±—É–¥—É—Ç –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω—ã.");
            document.getElementById('telegram-ui').style.display = 'none';
            tg = {
                MainButton: {
                    show: () => console.log("Debug: MainButton.show()"),
                    hide: () => console.log("Debug: MainButton.hide()"),
                    setText: (text) => console.log(`Debug: MainButton.setText("${text}")`),
                    onClick: (callback) => { window.tgMainButtonCallback = callback; },
                    showProgress: () => console.log("Debug: MainButton.showProgress()"),
                    hideProgress: () => console.log("Debug: MainButton.hideProgress()")
                },
                showAlert: (message) => alert(message),
                sendData: (data) => console.log("Debug: tg.sendData", JSON.parse(data))
            };
        }

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const booking = {};
        window.availableFilms = [];

        function showScreen(screenId) {
            if (!isTelegram) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            tg.MainButton.hide();
        }

        async function loadDates() {
            const { data, error } = await supabaseClient.from('schedule').select('*').gte('date', new Date().toISOString().split('T')[0]).order('date', { ascending: true });
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç:', error);
                if (isTelegram) document.getElementById('dates-container').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç.';
                return;
            }
            window.availableFilms = data;
            console.log("–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å–º—ã/–¥–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", window.availableFilms);
            
            if (isTelegram) {
                 const uniqueDates = [...new Set(data.map(item => item.date))];
                 const container = document.getElementById('dates-container');
                 container.innerHTML = '';
                 if (uniqueDates.length === 0) { container.innerText = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤.'; return; }
                 uniqueDates.forEach(date => {
                     const el = document.createElement('div');
                     el.className = 'list-item';
                     el.innerText = new Date(date + 'T00:00:00').toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric'});
                     el.onclick = () => { booking.date = date; loadFilms(date); };
                     container.appendChild(el);
                 });
            }
        }

        function loadFilms(date) {
            const filmsOnDate = window.availableFilms.filter(f => f.date === date);
            const container = document.getElementById('films-container');
            container.innerHTML = '';
            filmsOnDate.forEach(film => {
                const el = document.createElement('div');
                el.className = 'list-item';
                el.innerHTML = `<h3>${film.film_name}</h3><p>–ù–∞—á–∞–ª–æ –≤ ${film.film_time}</p>`;
                el.onclick = () => {
                    Object.assign(booking, { film_name: film.film_name, film_time: film.film_time, film_data: film });
                    loadSeats(film);
                };
                container.appendChild(el);
            });
            document.getElementById('film-screen-title').innerText = `üé¨ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –Ω–∞ ${new Date(date + 'T00:00:00').toLocaleDateString('ru-RU')}`;
            showScreen('film-screen');
        }
        
        function loadSeats(film) {
            document.getElementById('seat-screen-title').innerText = film.film_name;
            const container = document.getElementById('seats-container');
            container.innerHTML = '';
            const stdSeatsEl = document.createElement('div');
            stdSeatsEl.className = 'list-item';
            stdSeatsEl.innerHTML = `<h3>–û–±—ã—á–Ω—ã–π –ø—É—Ñ</h3><p>–î–æ—Å—Ç—É–ø–Ω–æ: ${film.std_total}</p>`;
            stdSeatsEl.onclick = () => { booking.seat_type = '–æ–±—ã—á–Ω—ã–π'; showUserDataScreen(); };
            const bigSeatsEl = document.createElement('div');
            bigSeatsEl.className = 'list-item';
            bigSeatsEl.innerHTML = `<h3>–ë–æ–ª—å—à–æ–π –ø—É—Ñ</h3><p>–î–æ—Å—Ç—É–ø–Ω–æ: ${film.big_total}</p>`;
            bigSeatsEl.onclick = () => { booking.seat_type = '–±–æ–ª—å—à–æ–π'; showUserDataScreen(); };
            if (film.std_total > 0) container.appendChild(stdSeatsEl);
            if (film.big_total > 0) container.appendChild(bigSeatsEl);
            showScreen('seat-screen');
        }

        function showUserDataScreen() {
            showScreen('user-data-screen');
            tg.MainButton.setText('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å');
            tg.MainButton.show();
        }

        async function mainButtonClickHandler() {
            if (isTelegram) {
                booking.quantity = document.getElementById('quantity-input').value;
                booking.name = document.getElementById('name-input').value;
                booking.phone = document.getElementById('phone-input').value;
            }

            booking.booking_code = String(Math.floor(10000 + Math.random() * 90000));
            booking.status = 'pending';

            if (!booking.name) { tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è.'); return; }
            if (!booking.quantity || booking.quantity < 1) { tg.showAlert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç.'); return; }
            
            tg.MainButton.showProgress();

            const { error } = await supabaseClient.from('bookings').insert([{ name: booking.name, phone: booking.phone, date: booking.date, film_name: booking.film_name, quantity: booking.quantity, seat_type: booking.seat_type, booking_code: booking.booking_code, status: 'pending' }]);
            if (error) {
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω—å. –û—à–∏–±–∫–∞: ' + error.message);
                tg.MainButton.hideProgress();
                return;
            }
            initTinkoffPayment();
        }
        
        function initTinkoffPayment() {
            const price = booking.seat_type === '–æ–±—ã—á–Ω—ã–π' ? 500 : 600;
            const amount = price * booking.quantity;
            
            document.getElementById('payment-container').style.display = 'flex';
            tg.MainButton.hideProgress();
            
            window.TinkoffWidget.init({
                terminalKey: TINKOFF_TERMINAL_KEY,
                amount: amount * 100,
                orderNumber: booking.booking_code,
                description: `–ë—Ä–æ–Ω—å ‚Ññ${booking.booking_code}: ${booking.film_name}`,
                email: booking.email || "", 
                phone: booking.phone || "",
                customerKey: (tg.initDataUnsafe && tg.initDataUnsafe.user) ? String(tg.initDataUnsafe.user.id) : booking.name,
                language: 'ru',
            }).embed(document.getElementById('payment-form'));

            window.TinkoffWidget.on('success', (res) => {
                 handlePaymentSuccess(res.orderNumber, res.paymentId, amount);
            });
            window.TinkoffWidget.on('fail', (res) => {
                 tg.showAlert(`–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${res.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'}`);
                 document.getElementById('payment-container').style.display = 'none';
            });
        }

        async function handlePaymentSuccess(orderId, paymentId, amount) {
            await supabaseClient.from('bookings').update({ status: 'active' }).eq('booking_code', orderId);
            
            if (isTelegram) {
                const dataToSend = JSON.stringify({ 
                    status: 'success', 
                    order_id: orderId, 
                    payment_id: paymentId,
                    amount: amount, 
                    description: `–ë—Ä–æ–Ω—å ‚Ññ${orderId}: ${booking.film_name}` 
                });
                tg.sendData(dataToSend);
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å tg.close() –∑–¥–µ—Å—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            } else {
                alert("–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! " + orderId);
                document.getElementById('payment-container').style.display = 'none';
            }
        }
        
        if (isTelegram) {
            tg.onEvent('mainButtonClicked', mainButtonClickHandler);
        } else {
            document.getElementById('debug-select-film-btn').onclick = () => {
                if (!window.availableFilms || window.availableFilms.length === 0) { alert("–§–∏–ª—å–º—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å."); return; }
                const firstFilm = window.availableFilms[0];
                Object.assign(booking, { date: firstFilm.date, film_name: firstFilm.film_name, film_time: firstFilm.film_time, film_data: firstFilm });
                console.log("–í—ã–±—Ä–∞–Ω —Ñ–∏–ª—å–º:", booking);
                alert(`–í—ã–±—Ä–∞–Ω —Ñ–∏–ª—å–º: ${booking.film_name}`);
            };
            document.getElementById('debug-select-seat-btn').onclick = () => {
                if (!booking.film_name) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º"); return; }
                Object.assign(booking, { seat_type: '–æ–±—ã—á–Ω—ã–π', quantity: 2 });
                console.log("–í—ã–±—Ä–∞–Ω—ã –º–µ—Å—Ç–∞:", booking);
                alert(`–í—ã–±—Ä–∞–Ω—ã –º–µ—Å—Ç–∞: 2 –æ–±—ã—á–Ω—ã—Ö –ø—É—Ñ–∞`);
            };
            document.getElementById('debug-confirm-btn').onclick = () => {
                if (!booking.seat_type) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞"); return; }
                Object.assign(booking, { name: "–¢–µ—Å—Ç –ë—Ä–∞—É–∑–µ—Ä", phone: "88005553535" });
                mainButtonClickHandler();
            };
        }

        document.getElementById('close-payment-btn').onclick = () => { document.getElementById('payment-container').style.display = 'none'; };
        
        window.onload = () => {
             if (isTelegram) showScreen('date-screen');
             loadDates();
        };
    </script>
</body>
</html>
